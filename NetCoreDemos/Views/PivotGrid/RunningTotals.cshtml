@using DevExtreme.NETCore.Demos.Models

@(Html.DevExtreme().PivotGrid<Sale>()
    .ID("sales")
    .AllowSortingBySummary(true)
    .AllowSorting(true)
    .AllowFiltering(true)
    .AllowExpandAll(true)
    .ShowColumnTotals(false)
    .ShowTotalsPrior(PivotGridTotalsDisplayMode.Rows)
    .ShowBorders(true)
    .FieldChooser(c => c.Enabled(false))
    .OnCellPrepared("cellPrepared")
    .DataSource(d => d
        .Store(s => s.Mvc().Controller("PivotGridData").LoadAction("Get"))
        .Fields(fields => {
            fields.AddFor(m => m.Region)
                .Width(120)
                .Area(PivotGridArea.Row);

            fields.AddFor(m => m.City)
                .Width(150)
                .Area(PivotGridArea.Row);

            fields.AddFor(m => m.Date)
                .Area(PivotGridArea.Column)
                .GroupInterval(PivotGridGroupInterval.Year)
                .Expanded(true);

            fields.Add()
                .Area(PivotGridArea.Column)
                .Expanded(true)
                .Selector("halfYearSelector");

            fields.AddFor(m => m.Amount)
                .SummaryType(SummaryType.Sum)
                .Format(Format.Currency)
                .Area(PivotGridArea.Data);

            fields.AddFor(m => m.Amount)
                .Caption("Running Total")
                .Area(PivotGridArea.Data)
                .SummaryType(SummaryType.Sum)
                .Format(Format.Currency)
                .RunningTotal(PivotGridRunningTotalMode.Row)
                .AllowCrossGroupCalculation(true);

            fields.Add()
                .Caption("Profit/Loss")
                .Area(PivotGridArea.Data)
                .DataType(PivotGridDataType.Number)
                .Format(Format.Currency)
                .CalculateSummaryValue("calculateProfitValue");
        })
    )
)

@(Html.DevExtreme().CheckBox()
    .Value(true)
    .Text("Allow cross-group running totals accumulation")
    .OnValueChanged("selectBox_valueChanged")
)

<script>
    function selectBox_valueChanged(e) {
        var pivotGridDataSource = $("#sales").dxPivotGrid("instance").getDataSource();

        pivotGridDataSource.field(6, { allowCrossGroupCalculation: e.value });
        pivotGridDataSource.load();
    }

    function halfYearSelector(item) {
        var currDate = new Date(item.Date);
        var currMonth = currDate.getMonth();
        return currMonth <= 5
            ? "H1"
            : "H2";
    }

    function calculateProfitValue(summaryCell) {
        var prevCell = summaryCell.prev('column', true);
        if (prevCell) {
            var prevVal = prevCell.value("Total");
            var currVal = summaryCell.value("Total");
            return currVal - prevVal;
        }
        return null;
    }

    function cellPrepared(e) {
        if (e.area === "data" && e.cell.dataIndex === 2) {
            e.cellElement[0].style.color = e.cell.value < 0
                ? "red"
                : "green";
        }
    }
</script>
